FROM docker.io/library/rockylinux:8.6

RUN sed -i /etc/yum.repos.d/Rocky*.repo \
      -e 's/^#baseurl=/baseurl=/' \
      -e 's/^mirrorlist=/#mirrorlist=/' \
    && echo 'vault/rocky' >/etc/dnf/vars/contentdir \
    && echo "8.6" >/etc/dnf/vars/releasever \
    && dnf clean all

RUN dnf update -y \
    && dnf install -y --allowerasing \
      coreutils \
      cpio \
      dhclient \
      e2fsprogs \
      ethtool \
      findutils \
      initscripts \
      ipmitool \
      iproute \
      kernel-core \
      kernel-modules \
      net-tools \
      NetworkManager \
      nfs-utils \
      openssh-clients \
      openssh-server \
      pciutils \
      psmisc \
      rsync \
      rsyslog \
      strace \
      wget \
      which \
      words \
    && dnf clean all

RUN systemctl unmask \
      console-getty.service \
      dev-hugepages.mount \
      getty.target \
      sys-fs-fuse-connections.mount \
      systemd-logind.service \
      systemd-remount-fs.service

COPY excludes /etc/warewulf/
COPY image_exit.sh /etc/warewulf/
RUN ln -s image_exit.sh /etc/warewulf/container_exit.sh

CMD [ "/bin/echo", "-e", \
      "This image is intended to be used with the Warewulf cluster management and", \
      "\nprovisioning system.", \
      "\n", \
      "\nFor more information about Warewulf, visit https://warewulf.org" ]
